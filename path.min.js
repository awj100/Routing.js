var Path=function(n,t){var r=this,f=!1,o={initial:{},pushState:function(t,i,f){r.history.supported?u(f)&&n.history.pushState(t,i,f):r.history.fallback&&(n.location.hash="#"+f)},popState:function(){var n=!r.history.initial.popped&&location.href==r.history.initial.URL;(r.history.initial.popped=!0,n)||u(t.location.pathname)},listen:function(t){var u,o,f;if(r.history.supported=!!(n.history&&n.history.pushState),r.history.fallback=t,r.history.supported)r.history.initial.popped="state"in n.history,r.history.initial.URL=location.href,n.onpopstate=r.history.popState;else if(r.history.fallback){for(u=0,o=i.defined.length;u<o;u++)f=i.defined[u],f.path.charAt(0)!="#"&&(f.path="#"+f.path);e()}}},s=function(n){var t=this;t.path=n;t.action=null;t.do_before=[];t.do_exit=null;t.params={};t.segments=[];t.mandatory=0;t.mandWithOpts=0;t.before=function(n){return n instanceof Array?this.do_before=this.do_before.concat(n):this.do_before.push(n),this};t.leaving=function(n){return this.do_exit=n,this};t.partition=function(){for(var t=[],n=[],u=/\(([^}]+?)\)/g,r,i=0;r=u.exec(this.path);)t.push(r[1]);for(n.push(this.path.split("(")[0]);i<t.length;i++)n.push(n[n.length-1]+t[i]);return n};t.run=function(){for(var u=!1,n=0,r=i.defined.length,f,t;n<r;n++)if(i.defined[n].path===this.path){if(t=i.defined[n],t.do_before.length>0)for(n=0,r=t.do_before.length;n<r;n++)if(f=t.do_before[n].apply(this,[]),f===!1){u=!0;break}u||t.action();break}};t.to=function(n){return this.action=n,this}},i={current:null,root:null,fallback:null,previous:null,defined:[]},h=function(n){for(var t=0,f=i.defined.length;t<f;t++)if(i.defined[t].path===n)return i.defined[t];for(var e=n.slice(1).split(/[/|\(/?]+/),r=new s(n),t=0,f=e.length;t<f;t++){var o=e[t],u=w(o),h=p(o,u);r.segments.push({segment:h,type:u});(u===0||u===1)&&r.mandatory++;r.mandWithOpts++}return i.defined.push(r),i.defined.sort(b),r},u=function(t){var r=t.split("/");if(r.pop()==="refresh")return n.location.hash=r.join("/"),f=!0,!1;if(i.current===null||i.current.path!==t||f){if(i.previous=i.current,i.current=a(t),f=!1,i.previous&&i.previous.do_exit!==null&&i.previous.do_exit(),i.current!==null)return i.current.run(),!0;i.fallback!==null&&i.fallback()}return!0},c=function(n){i.fallback=n},e=function(){var r=function(){u(location.hash)};location.hash===""&&i.root!==null&&(location.hash=i.root);"onhashchange"in n&&(!t.documentMode||t.documentMode>=8)?n.onhashchange=r:setInterval(u,50);location.hash!==""&&r()},l=function(n){return h(n)},a=function(n){for(var o=0,y=i.defined.length,s=n.slice(1).split("/"),t,f,h,a,e,v,c;o<y;o++)if(t=i.defined[o],!(s.length<t.mandatory)&&!(s.length>t.mandWithOpts)){for(var l=!0,r={},u=0,p=t.segments.length;u<p;u++)if(f=t.segments[u],h=s[u],f.type!==0)r[f.segment]={value:h,hasChanged:!0};else if(f.segment!==h){l=!1;break}if(l){if(i.current!==null&&i.current.path===t.path){a=i.current.params;for(e in r)v=r[e].value,c=a[e],r[e].hasChanged=typeof c!="undefined"?c.value!==v:!0}return t.params=r,t}}return null},v=function(){var t=i!==null&&i.current!==null?i.current.split("/"):[];return t.push("refresh"),n.location.hash=t.join("/"),!0},y=function(n){i.root=n},p=function(n,t){switch(t){case 1:return n.slice(1);case 2:return n.substr(1,n.length-2);default:return n}},w=function(n){return n.charAt(0)===":"?n.charAt(n.length-1)===")"?2:1:0},b=function(n,t){return n.mandWithOpts<t.mandWithOpts?-1:t.mandWithOpts<n.mandWithOpts?1:n.mandatory<t.mandatory?-1:n.mandatory>t.mandatory?1:0};return{version:"0.9.0",map:l,root:y,fallback:c,history:o,listen:e,refresh:v,routes:i}}(window,document);
