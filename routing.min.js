var Routing=function(t,e){var n=this,r=[],a=function(t,e,n){"undefined"==typeof n&&(n=!0),t=t.replace(/#!?\/?/,"");for(var r=t.split(/[\/|\(\/?]+/),a=0,o=r.length;a<o;a++){var i=r[a],l=b(i),h=m(i,l),u=e[h];switch(l){case 1:t=t.replace(":"+h,u);break;case 2:t="undefined"==typeof u?t.replace("(/:"+h+")",""):t.replace("(/:"+h+")","/"+u)}}return n?"#!/"+t:t},o=null,i={initial:{},pushState:function(e,r,a){n.history.supported?f(a)&&t.history.pushState(e,r,a):n.history.fallback&&(t.location.hash="#"+a)},popState:function(){var t=!n.history.initial.popped&&location.href==n.history.initial.URL;n.history.initial.popped=!0,t||f(e.location.pathname)},listen:function(e){if(n.history.supported=!(!t.history||!t.history.pushState),n.history.fallback=e,n.history.supported)n.history.initial=n.history.initial||{},n.history.initial.popped="state"in t.history,n.history.initial.URL=location.href,t.onpopstate=n.history.popState;else if(n.history.fallback){for(var r=0,a=u.defined.length;r<a;r++){var o=u.defined[r];"#"!=o.path.charAt(0)&&(o.path="#"+o.path)}p()}}},l=!1,h=function(t){var e=this;e.action=null,e.doBefore=[],e.doLeaving=null,e.fromCache=!1,e.mandatory=0,e.mandWithOpts=0,e.params={},e.path=t,e.segments=[],e.before=function(t){return"[object Array]"===Object.prototype.toString.call(t)?e.doBefore=e.doBefore.concat(t):e.doBefore.push(t),e},e.leaving=function(t){return e.doLeaving=t,e},e.run=function(){for(var t,n,a=0,o=u.defined.length;a<o;a++)if(u.defined[a].path===e.path){if(n=u.defined[a],n.doBefore.length>0)for(a=0,o=n.doBefore.length;a<o;a++)if(t=n.doBefore[a].apply(e,[]),"boolean"==typeof t&&!t)return!1;if(r.length>0)for(var i=0,l=r.length;i<l;i++)if(t=r[i].apply(e,[]),"boolean"==typeof t&&!t)return!1;"function"==typeof n.action&&n.action();break}},e.to=function(t){return e.action=t,e}},u={before:function(t){return"[object Array]"===Object.prototype.toString.call(t)?r=r.concat(t):r.push(t),this},cache:[],current:null,defined:[],fallback:null,leaving:function(t){return o=t,this},previous:null,root:null},c=function(t,e){if(null!==u.current){var n=u.current.params;for(var r in e){var a=e[r].value,o=n[r];e[r].hasChanged="undefined"==typeof o||o.value!==a}}t.params=e},f=function(e){var n=e.split("/");if("refresh"===n.pop())return t.location.hash=n.join("/"),l=!0,!1;if(e=e.replace(/#!?\/?/,""),null===u.current||u.current.path!==e||l){if(u.previous=u.current,u.current=y(e),l=!1,u.previous&&null!==u.previous.doLeaving&&"function"==typeof u.previous.doLeaving&&u.previous.doLeaving(),null!==o&&"function"==typeof o&&o(),null!==u.current)return u.current.run(),!0;null!==u.fallback&&u.fallback()}return!0},s=function(t){u.fallback=t},p=function(){var n=function(){f(t.location.hash)};""===t.location.hash&&null!==u.root&&(t.location.hash=u.root),"onhashchange"in t&&(!e.documentMode||e.documentMode>=8)?t.onhashchange=n:setInterval(n,50),""!==t.location.hash&&f(t.location.hash)},d=function(t){t=t.replace(/#!?\/?/,"");for(var e=0,n=u.defined.length;e<n;e++)if(u.defined[e].path===t)return u.defined[e];for(var r=t.split(/[\/|\(\/?]+/),a=new h(t),e=0,n=r.length;e<n;e++){var o=r[e],i=b(o),l=m(o,i);a.segments.push({segment:l,type:i}),0!==i&&1!==i||a.mandatory++,a.mandWithOpts++}return u.defined.push(a),u.defined.sort(k),a},y=function(t){for(var e,n=0,r=u.cache.length;n<r;n++)if(u.cache[n].path===t)return e=u.cache[n].mappedTo,c(e,u.cache[n].params),e.fromCache=!0,e;for(var n=0,r=u.defined.length,a=t.split("/");n<r;n++)if(e=u.defined[n],!(a.length<e.mandatory||a.length>e.mandWithOpts)){for(var o=!0,i={},l=0,h=e.segments.length;l<h;l++){var f=e.segments[l],s=a[l];if(0!==f.type)i[f.segment]={value:s,hasChanged:!0};else if(f.segment!==s){o=!1;break}}if(o)return u.cache.push({params:i,path:t,mappedTo:e}),e.fromCache=!1,c(e,i),e}return null},v=function(){var e=t.location.hash;return null!==e&&0!==e.length&&(t.location.hash=e+("/"===e.charAt(e.length-1)?"refresh":"/refresh"),!0)},g=function(t){u.root=t},m=function(t,e){switch(e){case 1:return t.slice(1);case 2:return t.substr(1,t.length-2);default:return t}},b=function(t){return":"===t.charAt(0)?")"===t.charAt(t.length-1)?2:1:0},k=function(t,e){return t.mandWithOpts<e.mandWithOpts?-1:e.mandWithOpts<t.mandWithOpts?1:t.mandatory<e.mandatory?-1:t.mandatory>e.mandatory?1:0};return{build:a,fallback:s,history:i,listen:p,map:d,refresh:v,root:g,routes:u,version:"0.9.4"}}(window,document);