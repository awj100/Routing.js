var Routing=function(t,e){var n=this,r=[],o=function(t,e,n){"undefined"==typeof n&&(n=!0),t=t.replace(/#!?\/?/,"");for(var r=t.split(/[\/|\(\/?]+/),o=0,a=r.length;o<a;o++){var i=r[o],l=b(i),h=m(i,l),u=e[h];"object"==typeof u&&"undefined"!=typeof u.value?u.value:u;switch(l){case 1:t=t.replace(":"+h,u);break;case 2:t="undefined"==typeof u?t.replace("(/:"+h+")",""):t.replace("(/:"+h+")","/"+u)}}return n?"#!/"+t:t},a=null,i={initial:{},pushState:function(e,r,o){n.history.supported?c(o)&&t.history.pushState(e,r,o):n.history.fallback&&(t.location.hash="#"+o)},popState:function(){var t=!n.history.initial.popped&&location.href==n.history.initial.URL;n.history.initial.popped=!0,t||c(e.location.pathname)},listen:function(e){if(n.history.supported=!(!t.history||!t.history.pushState),n.history.fallback=e,n.history.supported)n.history.initial=n.history.initial||{},n.history.initial.popped="state"in t.history,n.history.initial.URL=location.href,t.onpopstate=n.history.popState;else if(n.history.fallback){for(var r=0,o=u.defined.length;r<o;r++){var a=u.defined[r];"#"!=a.path.charAt(0)&&(a.path="#"+a.path)}p()}}},l=!1,h=function(t){var e=this;e.action=null,e.doBefore=[],e.doLeaving=null,e.fromCache=!1,e.mandatory=0,e.mandWithOpts=0,e.params={},e.path=t,e.segments=[],e.before=function(t){return"[object Array]"===Object.prototype.toString.call(t)?e.doBefore=e.doBefore.concat(t):e.doBefore.push(t),e},e.leaving=function(t){return e.doLeaving=t,e},e.run=function(){for(var t,n,o=0,a=u.defined.length;o<a;o++)if(u.defined[o].path===e.path){if(n=u.defined[o],n.doBefore.length>0)for(o=0,a=n.doBefore.length;o<a;o++)if(t=n.doBefore[o].apply(e,[]),"boolean"==typeof t&&!t)return!1;if(r.length>0)for(var i=0,l=r.length;i<l;i++)if(t=r[i].apply(e,[]),"boolean"==typeof t&&!t)return!1;"function"==typeof n.action&&n.action();break}},e.to=function(t){return e.action=t,e}},u={before:function(t){return"[object Array]"===Object.prototype.toString.call(t)?r=r.concat(t):r.push(t),this},cache:[],current:null,defined:[],fallback:null,leaving:function(t){return a=t,this},previous:null,root:null},f=function(t,e){if(null!==u.current){var n=u.current.params;for(var r in e){var o=e[r].value,a=n[r];e[r].hasChanged="undefined"==typeof a||a.value!==o}}t.params=e},c=function(e){var n=e.split("/");if("refresh"===n.pop())return t.location.hash=n.join("/"),l=!0,!1;if(e=e.replace(/#!?\/?/,""),null===u.current||u.current.path!==e||l){if(u.previous=u.current,u.current=y(e),l=!1,u.previous&&null!==u.previous.doLeaving&&"function"==typeof u.previous.doLeaving&&u.previous.doLeaving(),null!==a&&"function"==typeof a&&a(),null!==u.current)return u.current.run(),!0;null!==u.fallback&&u.fallback()}return!0},s=function(t){u.fallback=t},p=function(){var n=function(){c(t.location.hash)};""===t.location.hash&&null!==u.root&&(t.location.hash=u.root),"onhashchange"in t&&(!e.documentMode||e.documentMode>=8)?t.onhashchange=n:setInterval(n,50),""!==t.location.hash&&c(t.location.hash)},d=function(t){t=t.replace(/#!?\/?/,"");for(var e=0,n=u.defined.length;e<n;e++)if(u.defined[e].path===t)return u.defined[e];for(var r=t.split(/[\/|\(\/?]+/),o=new h(t),e=0,n=r.length;e<n;e++){var a=r[e],i=b(a),l=m(a,i);o.segments.push({segment:l,type:i}),0!==i&&1!==i||o.mandatory++,o.mandWithOpts++}return u.defined.push(o),u.defined.sort(k),o},y=function(t){for(var e,n=0,r=u.cache.length;n<r;n++)if(u.cache[n].path===t)return e=u.cache[n].mappedTo,f(e,u.cache[n].params),e.fromCache=!0,e;for(var n=0,r=u.defined.length,o=t.split("/");n<r;n++)if(e=u.defined[n],!(o.length<e.mandatory||o.length>e.mandWithOpts)){for(var a=!0,i={},l=0,h=e.segments.length;l<h;l++){var c=e.segments[l],s=o[l];if(0!==c.type)i[c.segment]={value:s,hasChanged:!0};else if(c.segment!==s){a=!1;break}}if(a)return u.cache.push({params:i,path:t,mappedTo:e}),e.fromCache=!1,f(e,i),e}return null},v=function(){var e=t.location.hash;return null!==e&&0!==e.length&&(t.location.hash=e+("/"===e.charAt(e.length-1)?"refresh":"/refresh"),!0)},g=function(t){u.root=t},m=function(t,e){switch(e){case 1:return t.slice(1);case 2:return t.substr(1,t.length-2);default:return t}},b=function(t){return":"===t.charAt(0)?")"===t.charAt(t.length-1)?2:1:0},k=function(t,e){return t.mandWithOpts<e.mandWithOpts?-1:e.mandWithOpts<t.mandWithOpts?1:t.mandatory<e.mandatory?-1:t.mandatory>e.mandatory?1:0};return{build:o,fallback:s,history:i,listen:p,map:d,refresh:v,root:g,routes:u,version:"0.9.4"}}(window,document);